#if 0
	shc Version 4.0.0, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -r -f deploy.sh 
#endif

static  char data [] = 
#define      xecc_z	15
#define      xecc	((&data[3]))
	"\004\300\075\047\120\047\264\052\243\112\221\015\342\335\257\346"
	"\063\220\215"
#define      tst1_z	22
#define      tst1	((&data[23]))
	"\163\321\030\277\061\345\355\016\304\337\304\151\370\071\171\036"
	"\167\230\117\204\043\042\373\357\070\314\072\151\313\212\302"
#define      msg2_z	19
#define      msg2	((&data[50]))
	"\304\316\251\346\307\032\065\341\152\252\121\222\256\261\356\064"
	"\213\072\004\016\347\002\143"
#define      inlo_z	3
#define      inlo	((&data[73]))
	"\036\312\222"
#define      date_z	1
#define      date	((&data[76]))
	"\156"
#define      msg1_z	65
#define      msg1	((&data[79]))
	"\335\145\375\317\264\030\335\204\170\254\064\022\070\175\113\273"
	"\210\012\020\055\167\251\011\241\364\173\100\223\366\310\074\077"
	"\003\330\056\076\056\316\125\247\167\064\007\226\303\310\271\202"
	"\174\005\154\151\301\376\026\067\201\031\024\140\025\222\231\370"
	"\352\067\054\376\133\073\350\316\014\001"
#define      chk1_z	22
#define      chk1	((&data[152]))
	"\130\133\211\325\015\262\235\172\010\325\057\314\133\346\012\167"
	"\006\056\024\174\311\033\112\320\055"
#define      chk2_z	19
#define      chk2	((&data[180]))
	"\001\277\001\145\350\213\026\103\130\264\316\366\337\004\221\344"
	"\245\327\043\157\036\262\247\007\253\174\067"
#define      lsto_z	1
#define      lsto	((&data[203]))
	"\237"
#define      rlax_z	1
#define      rlax	((&data[204]))
	"\362"
#define      tst2_z	19
#define      tst2	((&data[206]))
	"\041\240\375\147\243\014\011\272\064\153\173\245\356\206\141\341"
	"\331\233\326\074\100\133"
#define      shll_z	10
#define      shll	((&data[227]))
	"\071\075\014\005\204\231\140\235\317\302\164\254"
#define      opts_z	1
#define      opts	((&data[239]))
	"\341"
#define      text_z	2181
#define      text	((&data[301]))
	"\066\334\333\233\343\206\030\033\336\001\157\136\134\241\104\264"
	"\056\145\365\212\222\070\163\006\344\266\113\277\353\150\231\042"
	"\105\164\276\050\373\326\103\331\330\263\067\065\125\173\351\203"
	"\341\337\016\163\027\202\172\374\070\306\273\043\057\200\307\162"
	"\253\333\005\355\231\155\055\325\074\322\243\242\034\021\073\324"
	"\222\245\001\350\202\101\204\140\035\220\050\226\044\103\346\170"
	"\014\060\346\053\166\012\221\053\350\237\054\225\070\221\302\167"
	"\341\027\151\265\310\321\100\042\347\132\171\232\275\226\123\235"
	"\105\105\066\250\025\303\334\155\223\024\150\044\031\174\311\254"
	"\007\323\006\020\127\142\346\250\340\373\126\117\275\062\255\303"
	"\062\160\247\076\051\111\264\304\372\161\131\317\366\005\363\341"
	"\335\237\026\151\257\150\001\125\166\357\360\005\216\175\040\040"
	"\045\207\357\350\015\252\220\131\201\024\262\130\201\337\124\124"
	"\010\240\150\145\006\100\133\316\236\211\221\050\142\257\233\272"
	"\365\055\133\342\270\205\177\073\062\301\044\332\064\244\321\242"
	"\212\362\161\075\166\247\364\222\055\025\034\217\211\060\063\110"
	"\132\044\244\060\372\206\202\011\107\266\357\105\320\227\027\071"
	"\301\346\144\346\274\363\075\324\047\277\340\176\204\340\341\263"
	"\061\023\176\312\265\206\163\027\067\004\331\352\143\243\313\327"
	"\245\242\205\127\202\032\004\245\366\136\045\073\263\262\370\105"
	"\301\006\226\316\255\002\032\260\341\150\361\114\030\345\225\235"
	"\353\327\004\007\332\203\257\170\211\241\131\005\231\127\011\151"
	"\250\133\166\136\121\015\237\206\252\244\116\256\263\357\377\372"
	"\023\257\323\326\062\341\201\230\233\366\331\025\076\324\051\125"
	"\350\147\333\316\021\127\212\126\074\015\112\121\243\042\126\231"
	"\134\207\335\057\355\062\376\366\321\002\003\312\373\361\300\057"
	"\103\222\171\057\054\133\067\322\045\101\142\036\007\046\013\033"
	"\013\206\002\242\052\143\000\323\371\042\104\256\106\363\372\163"
	"\373\332\312\257\070\031\303\330\176\350\326\262\351\331\246\030"
	"\301\305\000\016\227\160\360\331\150\363\376\204\134\304\113\143"
	"\257\214\062\035\325\204\176\013\353\331\271\225\172\065\354\336"
	"\244\032\252\104\326\211\117\140\325\266\167\153\060\071\011\037"
	"\001\331\022\014\250\356\122\251\177\066\027\060\175\006\056\154"
	"\274\071\071\041\334\040\235\161\344\105\042\305\033\272\002\152"
	"\200\230\230\330\176\222\212\266\253\250\102\303\255\316\265\031"
	"\231\140\147\235\210\156\270\246\267\325\202\365\350\016\373\127"
	"\137\032\212\316\016\275\015\033\246\100\104\122\314\350\023\126"
	"\362\247\245\103\206\102\236\373\233\230\325\313\335\302\167\076"
	"\321\167\172\332\275\241\034\120\047\151\356\013\111\301\005\200"
	"\005\120\007\017\376\223\021\270\110\134\007\246\266\050\150\112"
	"\137\004\173\057\061\262\026\263\300\001\204\250\132\212\261\374"
	"\157\353\264\260\245\323\104\000\130\141\165\175\333\110\220\222"
	"\352\350\223\114\017\154\122\176\305\100\100\051\360\136\211\223"
	"\212\106\213\363\012\070\010\247\024\031\107\255\047\233\030\332"
	"\030\104\050\226\127\137\351\032\222\123\031\017\002\151\112\200"
	"\234\223\216\212\146\231\134\036\253\347\050\034\055\151\054\016"
	"\174\311\075\270\175\022\317\275\000\165\014\374\206\207\311\221"
	"\234\207\336\065\271\017\264\342\075\101\007\070\341\252\057\200"
	"\126\064\016\060\237\213\002\101\024\276\201\335\134\222\151\201"
	"\122\225\225\054\224\334\065\374\347\124\376\077\243\361\161\340"
	"\073\051\200\262\165\202\226\123\227\116\002\011\344\134\336\230"
	"\061\013\245\063\315\116\036\157\056\204\211\304\026\306\233\137"
	"\367\005\206\213\343\220\350\247\214\337\024\357\315\264\234\274"
	"\335\362\304\370\164\321\120\045\376\224\036\146\242\045\022\172"
	"\113\262\040\333\313\203\370\323\171\047\214\235\151\313\300\265"
	"\312\044\076\165\215\334\007\357\045\224\052\024\313\034\341\360"
	"\015\335\173\302\241\143\143\220\125\265\030\360\273\062\017\245"
	"\175\276\250\251\247\156\331\327\134\247\243\171\224\150\151\145"
	"\365\025\051\273\330\041\001\062\312\072\214\272\171\364\163\244"
	"\157\023\005\207\137\111\062\202\200\110\303\050\140\037\104\234"
	"\174\217\351\305\232\346\161\055\233\043\243\015\347\115\365\321"
	"\256\065\125\052\075\127\044\207\217\343\054\136\346\241\001\010"
	"\126\072\002\330\166\330\262\204\102\074\210\303\254\252\142\312"
	"\212\210\217\265\116\250\112\326\016\372\142\012\044\015\310\345"
	"\357\165\235\204\141\307\162\021\051\306\024\137\226\044\357\330"
	"\246\013\123\053\164\235\373\222\335\001\043\300\211\247\115\344"
	"\264\363\121\142\360\011\354\270\012\045\166\267\006\204\177\160"
	"\353\051\275\313\060\203\201\020\324\265\202\216\036\043\076\327"
	"\230\265\321\316\343\340\331\210\045\155\331\072\141\255\236\313"
	"\027\156\160\325\235\127\111\204\011\204\137\011\037\364\116\062"
	"\144\125\130\057\045\253\110\007\206\026\334\265\172\101\122\032"
	"\061\306\011\035\240\327\031\367\115\333\336\105\214\332\170\271"
	"\335\071\322\145\217\116\214\005\045\372\207\004\143\226\143\315"
	"\352\173\167\164\127\261\362\202\377\341\207\257\105\351\067\050"
	"\371\361\006\075\303\045\146\315\223\216\324\265\272\265\311\206"
	"\341\003\065\140\213\333\207\042\143\000\023\225\300\173\037\304"
	"\065\153\244\116\142\133\315\205\217\306\347\022\254\337\031\025"
	"\054\321\235\277\240\353\224\036\033\105\177\023\030\010\321\077"
	"\326\355\271\040\232\235\234\207\067\105\037\104\126\011\233\130"
	"\052\145\076\352\275\253\236\276\342\252\130\376\144\173\330\013"
	"\126\343\153\311\074\023\075\344\245\061\045\221\364\264\214\334"
	"\167\012\034\145\325\352\370\116\017\044\130\115\002\013\323\072"
	"\102\046\127\352\354\317\170\215\207\245\107\146\366\372\112\210"
	"\326\121\234\156\212\324\116\110\354\337\110\026\040\260\012\002"
	"\077\322\111\060\330\314\010\030\300\105\142\372\176\376\062\355"
	"\146\354\362\153\271\072\017\223\011\037\171\030\111\043\035\164"
	"\352\065\270\325\226\310\012\140\106\330\334\131\137\121\254\336"
	"\212\016\330\314\245\067\057\023\001\037\341\167\003\107\127\263"
	"\344\322\255\256\317\364\224\220\203\046\050\230\242\166\115\341"
	"\047\311\330\077\046\353\150\333\051\373\166\031\112\355\201\011"
	"\363\350\005\173\145\323\375\366\054\156\230\115\240\117\161\300"
	"\150\156\352\172\165\110\327\022\100\140\365\207\310\133\250\350"
	"\253\113\334\201\366\157\107\305\024\370\065\245\167\312\103\063"
	"\345\371\204\150\351\021\242\135\344\271\071\300\343\152\067\170"
	"\247\331\160\316\124\357\300\273\071\002\011\074\350\273\360\175"
	"\205\227\176\065\163\100\130\243\217\230\054\325\211\175\020\255"
	"\252\363\044\256\363\201\217\031\276\112\142\356\063\022\200\065"
	"\074\174\343\105\112\142\335\232\262\112\235\077\044\253\004\203"
	"\263\024\133\057\332\311\011\132\243\376\253\366\374\073\256\277"
	"\251\012\201\065\112\120\074\163\377\157\140\137\307\231\357\163"
	"\113\076\205\044\173\155\361\037\363\031\037\230\170\020\303\367"
	"\114\207\373\310\362\211\073\307\075\054\311\243\143\243\142\234"
	"\240\044\050\242\146\205\270\227\132\064\055\040\013\065\022\341"
	"\074\073\000\322\107\004\175\102\353\115\207\042\012\364\134\233"
	"\066\344\360\043\047\020\151\313\234\023\034\024\155\232\000\053"
	"\206\254\305\167\324\361\041\145\162\063\274\375\243\252\046\255"
	"\234\221\127\017\263\222\231\231\105\363\027\201\371\173\242\263"
	"\374\316\370\055\273\210\033\042\214\337\356\243\246\327\044\263"
	"\064\045\324\347\121\256\360\016\053\121\103\214\264\315\054\010"
	"\153\074\270\050\277\125\031\273\144\315\113\221\112\131\326\060"
	"\125\011\024\063\340\336\271\247\263\145\143\133\066\367\265\301"
	"\167\224\230\157\131\204\051\347\143\325\113\335\112\124\016\037"
	"\010\373\151\354\075\026\246\317\153\262\024\022\223\365\222\035"
	"\301\033\230\035\337\120\302\024\304\375\331\341\210\303\117\132"
	"\340\162\134\373\304\021\324\363\203\165\127\251\000\013\212\246"
	"\043\236\143\223\115\070\030\254\164\130\230\302\266\322\066\017"
	"\305\061\272\070\141\331\162\036\132\174\174\267\070\322\166\020"
	"\366\175\252\203\365\150\070\304\007\122\150\145\032\172\035\303"
	"\155\021\161\123\045\321\164\373\367\024\013\010\266\016\135\005"
	"\227\134\045\335\025\016\274\226\375\315\360\252\265\003\167\045"
	"\223\355\343\260\036\022\154\133\117\373\346\040\062\376\013\020"
	"\321\174\103\206\001\173\005\361\133\054\303\204\000\266\034\045"
	"\005\125\113\303\342\175\131\217\210\245\137\252\307\125\261\063"
	"\272\075\100\323\102\343\015\004\333\276\222\015\363\350\162\151"
	"\071\041\140\212\060\021\161\122\361\172\226\256\166\154\103\274"
	"\046\046\140\115\164\214\263\357\234\230\173\070\247\212\064\142"
	"\062\376\326\116\220\036\231\074\120\165\366\300\030\341\122\215"
	"\213\255\025\245\235\213\032\107\371\300\241\352\232\043\071\034"
	"\013\207\326\342\066\241\206\066\307\144\105\350\362\036\260\377"
	"\111\247\162\324\307\173\341\023\240\305\114\335\055\073\274\303"
	"\174\100\064\121\001\207\020\001\340\343\206\222\047\270\366\017"
	"\003\207\275\271\255\045\201\144\033\374\143\307\376\163\110\034"
	"\303\352\241\276\347\143\072\045\042\237\151\133\111\343\144\204"
	"\103\361\107\371\302\145\270\373\244\065\170\356\306\272\005\136"
	"\000\275\151\003\330\132\213\120\063\264\015\074\112\250\077\215"
	"\240\014\140\135\300\265\327\002\156\255\205\131\015\064\132\175"
	"\337\306\037\342\215\031\106\162\074\067\260\244\270\160\233\266"
	"\131\253\155\151\364\266\275\077\367\163\330\021\270\137\005\275"
	"\211\134\323\204\310\354\004\070\112\310\242\173\372\245\052\337"
	"\103\020\006\355\010\013\055\365\105\342\132\312\306\112\121\267"
	"\107\356\124\106\164\311\004\234\304\333\340\235\264\224\325\351"
	"\351\121\323\155\062\262\173\246\312\375\040\307\066\346\203\132"
	"\025\330\240\212\241\245\046\146\200\007\004\065\234\331\036\205"
	"\052\361\362\134\244\156\003\157\154\043\066\242\012\271\374\040"
	"\221\235\252\063\102\321\231\302\331\235\367\165\166\026\373\241"
	"\010\356\376\255\134\001\034\310\045\122\152\060\014\147\121\235"
	"\004\373\320\106\315\152\011\247\007\001\034\176\030\030\037\040"
	"\006\036\315\142\037\351\053\104\074\225\165\110\375\306\346\001"
	"\302\267\110\217\041\121\066\050\123\123\247\153\153\306\213\162"
	"\344\131\324\004\102\377\111\177\225\276\307\222\204\256\224\106"
	"\145\334\326\206\056\015\257\201\140\126\355\314\035\171\076\002"
	"\322\023\007\025\023\120\224\250\017\134\073\223\012\320\332\160"
	"\254\261\366\333\276\246\135\037\375\112\354\033\304\053\035\226"
	"\076\044\254\121\165\100\372\204\235\066\030\250\006\363\030\263"
	"\244\017\216\142\266\353\202\263\066\156\316\372\232\354\221\330"
	"\021\075\052\206\176\045\012\033\134\043\304\142\026\335\025\272"
	"\355\244\035\243\220\240\127\306\016\046\301\251\022\122\202\043"
	"\217\254\252\015\322\264\051\056\327\356\221\355\313\247\250\270"
	"\113\305\134\334\145\263\242\164\332\143\035\354\265\237\020\105"
	"\114\272\123\037\157\174\116\106\153\340\064\066\207\334\357\323"
	"\242\114\257\010\000\122\174\332\265\232\306\153\072\327\261\207"
	"\221\004\247\000\201\365\107\354\325\173\043\135\130\023\060\373"
	"\140\340\003\140\062\200\072\347\032\001\123\125\330\005\335\152"
	"\011\204\153\213\172\262\170\117\056\234\255\207\257\335\202\017"
	"\275\205\160\360\005\252\330\040\254\053\166\205\060\123\357\072"
	"\327\133\306\121\015\076\241\074\332\116\303\211\054\106\231\352"
	"\313\011\332\321\264\262\362\140\336\150\346\017\274\326\112\223"
	"\061\020\345\077\116\207\173\050\326\077\262\002\205\114\355\121"
	"\126\310\043\012\172\026\153\131\176\121\150\072\047\262\316\131"
	"\302\264"
#define      pswd_z	256
#define      pswd	((&data[2950]))
	"\024\071\021\123\257\254\003\226\130\256\100\263\120\061\361\130"
	"\372\346\104\260\346\307\302\034\014\042\350\036\302\240\323\137"
	"\217\133\046\077\010\051\325\141\330\026\024\050\110\005\200\102"
	"\354\305\362\322\214\265\357\231\327\330\270\232\170\214\371\010"
	"\347\040\107\360\111\035\121\041\063\145\112\174\153\313\276\127"
	"\220\261\052\035\147\031\267\077\362\157\332\153\373\324\163\343"
	"\364\273\323\075\331\044\137\015\212\252\211\365\165\107\115\006"
	"\371\167\044\140\221\333\240\203\113\172\357\107\116\142\052\102"
	"\036\376\200\367\043\340\004\255\212\215\243\377\325\361\006\317"
	"\150\052\060\372\005\320\176\121\113\155\230\232\320\303\334\356"
	"\302\135\345\345\075\352\223\310\170\067\310\116\050\316\035\221"
	"\370\115\213\376\036\012\117\151\167\350\003\107\253\340\066\155"
	"\075\034\123\173\006\346\104\177\035\014\315\106\332\352\327\323"
	"\070\143\321\126\155\041\300\345\011\303\055\264\244\143\042\342"
	"\200\165\135\206\134\242\005\171\256\322\300\211\275\230\134\365"
	"\373\056\113\151\120\013\117\131\317\174\016\163\340\061\125\140"
	"\246\263\347\002\354\024\331\070\002\053\217\312\117\231\104\145"
	"\005\235\344"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define HARDENINGSP	0	/* Define as 1 to disable bash child process */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a processs */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;

    int lentmp = len;

#if HARDENINGSP
    //Start tracing to protect from dump & trace
    if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }

    //Decode Bash
    while (len > 0) {
        indx++;
        tmp = stte[indx];
        jndx += tmp;
        stte[indx] = stte[jndx];
        stte[jndx] = tmp;
        tmp += stte[indx];
        *ptr ^= stte[tmp];
        ptr++;
        len--;
    }

    //Exec bash script
    system(tmp2);

    //Empty script variable
    memcpy(tmp2, str, lentmp);

    //Sinal to detach ptrace
    ptrace(PTRACE_DETACH, 0, 0, 0);
    exit(0);

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
#endif /* HARDENINGSP Exit here anyway*/

    int pid, status;
    pid = fork();

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            printf("Operation not permitted\n");
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Exec bash script
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {
        wait(&status);
    }

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
} 
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
